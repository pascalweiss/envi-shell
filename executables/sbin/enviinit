#!/usr/bin/env bash
#
# ENVI ENVIRONMENT INITIALIZATION SCRIPT
# =====================================
# 
# This script is the core initialization component of the envi shell system.
# It is sourced by ALL shell instances (interactive and non-interactive) via ~/.envi_rc
# 
# EXECUTION ORDER:
# 1. Shell startup (.zshrc) 
# 2. source ~/.envi_rc
# 3. â†’ enviinit (THIS SCRIPT) - Universal environment setup
# 4. Oh-My-Zsh framework loading (zsh only)
# 5. envi_post_init - Interactive session features only
#
# DESIGN PRINCIPLES:
# - Only put universal environment setup here (PATH, variables, sourcing configs)
# - NO interactive features (those go in envi_post_init)
# - Must work in both interactive and non-interactive shells
# - Defaults loaded first, then user config to override defaults
#
# STRUCTURE:
# 1. Platform-specific executable paths
# 2. Default configurations and common utilities
# 3. User configuration loading (with feature controls)
# 4. Environment settings (colors, locale)
# 5. Tool integrations (via tool-integrations/ structure)

# ============================================================================
# PLATFORM-SPECIFIC EXECUTABLE PATHS
# ============================================================================

# System-critical PATH (essential system directories)
export PATH="$PATH:/usr/local/bin:/usr/bin:/bin:/usr/sbin:/sbin"

# Load platform-specific CLI tools
if [[ "$(uname)" = *Darwin* ]]; then 
    export PATH=$PATH:$ENVI_HOME/executables/macbin
elif [[ "$(uname)" = *Linux* ]]; then 
    export PATH=$PATH:$ENVI_HOME/executables/linuxbin
fi

# Universal executables (work on all platforms)
export PATH=$PATH:$ENVI_HOME/executables/bin

# ============================================================================
# DEFAULT CONFIGURATIONS AND COMMON UTILITIES
# ============================================================================

# Load common shell functions (contains, add_symlink, 256colors)
source $ENVI_HOME/executables/bin/commons

# System-critical envi aliases (required for envi system functionality)
alias envi="cd \$ENVI_HOME"
alias loc="vim ~/.envi/config/.envi_locations"
alias environ="vim ~/.envi/config/.envi_env"
alias short="vim ~/.envi/config/.envi_shortcuts"

# ============================================================================
# DEFAULT CONFIGURATION LOADING
# ============================================================================
# Load system defaults first (provides baseline configuration)

# Load default environment variables and feature controls
source $ENVI_HOME/defaults/default_env_user.sh

# Load default path locations
source $ENVI_HOME/defaults/default_locations.sh

# Load default shortcuts and aliases
source $ENVI_HOME/defaults/default_shortcuts.sh

# ============================================================================
# USER CONFIGURATION LOADING (OVERRIDES DEFAULTS)
# ============================================================================
# Load user configs second so they can override defaults

# Load user environment variables and feature controls (overrides defaults)
if [ -f "$ENVI_HOME/config/.envi_env" ]; then 
    source $ENVI_HOME/config/.envi_env; 
fi

# Load user-defined path locations (overrides defaults)  
if [ -f "$ENVI_HOME/config/.envi_locations" ]; then 
    source $ENVI_HOME/config/.envi_locations; 
fi

# Load user-defined shortcuts and aliases (overrides defaults)
if [ -f "$ENVI_HOME/config/.envi_shortcuts" ]; then 
    source $ENVI_HOME/config/.envi_shortcuts; 
fi

# ============================================================================
# ENVIRONMENT SETTINGS
# ============================================================================

# Apply terminal color settings
if [ "$ENVI_256_COLORS" = "true" ]; then 256colors true; else 256colors false; fi

# Set UTF-8 locale for proper character encoding
if [ "$ENVI_UTF_8" = "true" ]; then export LC_ALL="en_US.UTF-8"; fi

# ============================================================================
# TOOL INTEGRATIONS
# ============================================================================

# Load Homebrew initialization
source "$ENVI_HOME/tool-integrations/homebrew/init.sh"

# Load Neovim initialization
source "$ENVI_HOME/tool-integrations/neovim/init.sh"

# Load zsh/oh-my-zsh configuration and initialization
source "$ENVI_HOME/tool-integrations/zsh/init.sh"

# Load SSH initialization
source "$ENVI_HOME/tool-integrations/ssh/init.sh"

# Load Node/NVM initialization
source "$ENVI_HOME/tool-integrations/node/init.sh"

# Load Flux initialization
source "$ENVI_HOME/tool-integrations/flux/init.sh"

# Load Angular CLI initialization
source "$ENVI_HOME/tool-integrations/angular/init.sh"

# Load tmux initialization
source "$ENVI_HOME/tool-integrations/tmux/init.sh"

# ============================================================================
# END OF ENVIINIT
# ============================================================================
